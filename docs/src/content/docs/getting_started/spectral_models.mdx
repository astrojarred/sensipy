---
title: Spectral Models
description: How to format and load spectral models.
---

import {Aside, Code, Tabs, TabItem} from "@astrojs/starlight/components";

## Overview

sensipy supports time-resolved spectral models that describe how the source emission evolves over time. The data should contain spectra at varying times (or lightcurves at varying energies, depending on how you prefer to think about it).

Currently, the supported file formats are:

- **CSV files** (recommended)
- **FITS files**
- **Text files** (directory of `.txt` files)

<Aside>
  CSV files are the current recommended format for sensipy spectral models due
  to their flexibility and ease of use.
</Aside>

## CSV File Format

The code expects a CSV file with three columns: `time`, `energy`, and `flux` (dNdE) with the following units:

- **time**: seconds (s)
- **energy**: GeV
- **dNdE**: 1 / (cm² s GeV) - differential flux

Multiple spectra can be included in the same file, each with a different time. The code will automatically organize the data into a time-energy grid.

### Sample CSV File

A full sample CSV file is available in the `data/mock_data` directory. The first rows look something like this:

```csv
time [s],energy [GeV],dNdE [cm-2 s-1 GeV-1]
1.061,1.04823,1e-08
1.061,1.14937,8.3179e-09
1.061,1.26026,6.9185e-09
1.061,1.38184,5.7547e-09
1.061,1.51516,4.7861e-09
...
```

### Column Name Flexibility

The CSV reader is flexible with column names:

- Column names are case-insensitive
- Substring matching is supported (e.g., "Time" will match "time [s]")
- The code looks for columns containing: `time`, `energy`, and `flux` or `dnde`

### Loading a CSV File

```python
from sensipy.source import Source
import astropy.units as u

# Load CSV spectral model
source = Source(
    filepath="data/mock_data/GRB_42_mock.csv",
    min_energy=30 * u.GeV,
    max_energy=10 * u.TeV,
)

# Optionally add EBL absorption
source_with_ebl = Source(
    filepath="data/mock_data/GRB_42_mock.csv",
    min_energy=30 * u.GeV,
    max_energy=10 * u.TeV,
    ebl="franceschini"
)
```

## FITS File Format

FITS files can also be used to store spectral models. The expected structure is:

- **HDU[1]**: Energy array (in GeV)
- **HDU[2]**: Time array (in seconds)
- **HDU[3]**: Flux array (2D, shape: `[n_energy, n_time]`, units: cm⁻² s⁻¹ GeV⁻¹)
- **HDU[0]** (optional): Metadata (source properties)

### FITS Example

```python
from sensipy.source import Source
import astropy.units as u

# Load FITS spectral model
source = Source(
    filepath="data/mock_data/GRB_42_mock.fits",
    min_energy=30 * u.GeV,
    max_energy=10 * u.TeV,
    ebl="dominguez"
)
```

## Metadata

Metadata provides additional information about the source, such as sky coordinates, distance, energy output, and jet properties. This information is particularly useful for GW event followup simulations.

### Supported Metadata Fields

When present in your data files, sensipy will extract the following metadata:

| Field                  | Description                 | Units   |
| ---------------------- | --------------------------- | ------- |
| `long` or `ra`         | Right Ascension / Longitude | radians |
| `lat` or `dec`         | Declination / Latitude      | radians |
| `eiso`                 | Isotropic energy output     | erg     |
| `dist` or `distance`   | Luminosity distance         | kpc     |
| `angle` or `jet_angle` | Jet opening angle           | degrees |
| `fluence`              | Energy fluence              | erg/cm² |

### CSV Metadata File

For CSV spectral models, you can provide a separate metadata file with the same basename plus `_metadata.csv`:

```
GRB_42_mock.csv
GRB_42_mock_metadata.csv
```

Example metadata CSV:

```csv
long,lat,eiso,dist,angle
2.623,0.186,2.67e+50,466000,24.521
```

### FITS Metadata

For FITS files, metadata can be included in the header of HDU[0]:

```python
from astropy.io import fits

# Read FITS metadata
with fits.open("GRB_42_mock.fits") as hdul:
    header = hdul[0].header
    long = header.get('LONG')
    lat = header.get('LAT')
    eiso = header.get('EISO')
    dist = header.get('DIST')
```

### Accessing Metadata

Once loaded, metadata is accessible through the `metadata` property:

```python
from sensipy.source import Source

source = Source(filepath="data/mock_data/GRB_42_mock.csv")

# Access metadata
meta = source.metadata
print(f"Event ID: {meta.get('id')}")
print(f"Distance: {meta.get('dist')} kpc")
print(f"Isotropic energy: {meta.get('eiso')} erg")
print(f"Coordinates: RA={meta.get('long')}, Dec={meta.get('lat')}")
```

## Text File Directory Format

For legacy support, sensipy can also read spectral data from a directory of text files. Each file should be named with the pattern:

```
{basename}_tobs=NN.txt
```

Where `NN` is the observation time index. Each file contains two columns: energy (GeV) and flux (cm⁻² s⁻¹ GeV⁻¹).

<Aside type="note">
  This format is primarily for backward compatibility. New data should use CSV
  or FITS formats.
</Aside>

## Spectral Grid and Interpolation

After loading a spectral model, sensipy creates an interpolation grid in log-space (log energy, log time) to enable efficient querying at arbitrary times and energies.

### Querying the Spectrum

```python
import astropy.units as u

# Get spectrum at a specific time
time = 100 * u.s
spectrum = source.get_spectrum(time=time)

# Get flux at a specific energy and time
energy = 1 * u.TeV
flux = source.get_flux(energy=energy, time=time)

# Get lightcurve at a specific energy
lightcurve = source.get_flux(energy=energy)
```

### Visualizing the Spectral Pattern

```python
# Show the full time-energy spectral pattern
source.show_spectral_pattern(
    resolution=100,  # Grid resolution
    return_plot=True
)
```

## Energy Range Considerations

When loading spectral models, you should specify the energy range of interest. This helps:

1. **Optimize performance** by limiting interpolation to relevant energies
2. **Match observatory capabilities** (e.g., CTA energy range)
3. **Ensure EBL absorption** is applied correctly

```python
# Typical CTA energy range
min_energy = 20 * u.GeV  # or 0.02 TeV
max_energy = 10 * u.TeV

source = Source(
    filepath="path/to/model.csv",
    min_energy=min_energy,
    max_energy=max_energy,
)
```

## Best Practices

1. **Use CSV format** for new spectral models - it's the most flexible and debuggable
2. **Include metadata** when available - it's essential for GW event cataloging
3. **Use consistent units** - stick to the expected units (s, GeV, cm⁻² s⁻¹ GeV⁻¹)
4. **Specify energy ranges** - always define `min_energy` and `max_energy` appropriate for your observatory
5. **Add EBL absorption** for extragalactic sources - use appropriate EBL models for high-redshift sources

## Next Steps

- Learn about [EBL Models](./ebl_models) and when to apply them
- See the [Tutorials](/tutorials/) for complete workflow examples
- Check the [Source class API](/reference/source) for detailed method documentation
