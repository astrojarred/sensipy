---
title: Sensitivity Calculations
description: How to calculate the sensitivity of an observatory to a given source.
---

import {Aside, Steps, Tabs, TabItem, Code} from "@astrojs/starlight/components";

## Overview

Sensitivity calculations determine the minimum detectable flux for a gamma-ray observatory under specific observing conditions. In sensipy, sensitivity curves are used to evaluate whether a time-varying source (like a GRB) can be detected and how long it would take to reach a specified significance level.

<Aside type="tip">
  sensipy uses [Gammapy](https://gammapy.org/) under the hood for sensitivity
  calculations, providing state-of-the-art analysis tools compatible with CTAO.
</Aside>

## What is a Sensitivity Curve?

A **sensitivity curve** represents the minimum differential flux (energy flux per unit energy) that an observatory can detect at a given significance level, as a function of observation time.

For each observation time, the sensitivity curve provides:

- **Differential sensitivity**: Minimum detectable dN/dE [cm⁻² s⁻¹ GeV⁻¹]
- **Photon flux sensitivity**: Minimum detectable photon flux [cm⁻² s⁻¹]

These curves depend on:

- **Instrument Response Functions (IRFs)**: Define telescope performance
- **Observing conditions**: Zenith angle, azimuth, site (North/South)
- **Energy range**: Energy window of interest
- **Source spectrum**: The assumed spectral shape
- **Region of interest**: Spatial extraction region size

## Creating a Sensitivity Calculator

sensipy provides the `SensitivityGammapy` class for calculating sensitivity curves using Gammapy:

```python
from sensipy.ctaoirf import IRFHouse
from sensipy.sensitivity import SensitivityGammapy
import astropy.units as u

# Load IRFs
house = IRFHouse(base_directory="./CTA-IRFs")
irf = house.get_irf(
    site="south",
    configuration="alpha",
    zenith=20,
    duration=1800,  # seconds
    azimuth="average",
    version="prod5-v0.1",
)

# Create sensitivity calculator
sensitivity = SensitivityGammapy(
    irf=irf,
    observatory=f"ctao_{irf.site.name}",  # "ctao_south"
    min_energy=20 * u.GeV,
    max_energy=10 * u.TeV,
    radius=3.0 * u.deg,  # Region of interest radius
)
```

### Key Parameters

| Parameter              | Description                  | Typical Value                  |
| ---------------------- | ---------------------------- | ------------------------------ |
| `irf`                  | Instrument response function | From `IRFHouse`                |
| `observatory`          | Observatory name             | `"ctao_south"` or `"ctao_north"` |
| `min_energy`           | Minimum energy               | `20 GeV` or `0.02 TeV`         |
| `max_energy`           | Maximum energy               | `10 TeV`                       |
| `radius`               | Extraction region radius     | `3.0 deg` (for point sources)  |
| `n_sensitivity_points` | Number of time points        | `16` (default)                 |

## Computing Sensitivity for a Source

Once you have a `Source` object with a time-resolved spectrum, you can compute the sensitivity curve:

<Tabs>
  <TabItem label="Basic Example">
    ```python
    from sensipy.source import Source
    from sensipy.sensitivity import SensitivityGammapy
    import astropy.units as u

    # Load source
    source = Source(
        filepath="path/to/grb_spectrum.csv",
        min_energy=20 * u.GeV,
        max_energy=10 * u.TeV,
        ebl="franceschini"
    )

    # Create sensitivity calculator
    sens = SensitivityGammapy(
        irf=irf,
        observatory="ctao_south",
        min_energy=20 * u.GeV,
        max_energy=10 * u.TeV,
        radius=3.0 * u.deg,
    )

    # Compute sensitivity curve for this source
    sens.get_sensitivity_curve(grb=source)

    # Access the sensitivity curve
    print(sens.sensitivity_curve)
    print(sens.photon_flux_curve)
    ```

  </TabItem>
  
  <TabItem label="Custom Time Range">
    ```python
    from sensipy.sensitivity import SensitivityGammapy
    import astropy.units as u

    # Specify custom time range
    sens = SensitivityGammapy(
        irf=irf,
        observatory="ctao_south",
        min_energy=20 * u.GeV,
        max_energy=10 * u.TeV,
        radius=3.0 * u.deg,
        min_time=10 * u.s,       # Start at 10 seconds
        max_time=36000 * u.s,    # Up to 10 hours
        n_sensitivity_points=20,  # 20 time points
    )

    sens.get_sensitivity_curve(grb=source)
    ```

  </TabItem>
  
  <TabItem label="Pre-computed Curves">
    ```python
    from sensipy.sensitivity import SensitivityGammapy
    import astropy.units as u
    import numpy as np

    # Use pre-computed sensitivity values
    times = np.logspace(1, 4, 20) * u.s  # 10s to 10,000s
    sens_values = np.array([...]) * u.Unit("erg / (cm2 s)")
    photon_flux_values = np.array([...]) * u.Unit("1 / (cm2 s)")

    sens = SensitivityGammapy(
        irf=irf,
        observatory="ctao_south",
        min_energy=20 * u.GeV,
        max_energy=10 * u.TeV,
        radius=3.0 * u.deg,
        sensitivity_curve=sens_values,
        photon_flux_curve=photon_flux_values,
    )
    ```

  </TabItem>
</Tabs>

## Querying Sensitivity Values

After computing the sensitivity curve, you can query sensitivity at arbitrary times:

```python
import astropy.units as u

# Get sensitivity at a specific time
time = 1000 * u.s
diff_sens = sens.get(time, mode="sensitivity")
phot_flux = sens.get(time, mode="photon_flux")

print(f"At t={time}:")
print(f"  Differential sensitivity: {diff_sens}")
print(f"  Photon flux sensitivity: {phot_flux}")
```

## Sensitivity Modes

sensipy supports two sensitivity modes:

### 1. Differential Sensitivity

The minimum detectable **energy flux per unit energy** (dN/dE):

```python
# Differential sensitivity in erg cm⁻² s⁻¹
diff_sens = sens.get(time, mode="sensitivity")
```

Unit: `erg cm⁻² s⁻¹` or `TeV cm⁻² s⁻¹`

### 2. Photon Flux Sensitivity

The minimum detectable **photon flux** (integrated over energy):

```python
# Photon flux sensitivity in cm⁻² s⁻¹
phot_flux = sens.get(time, mode="photon_flux")
```

Unit: `cm⁻² s⁻¹`

## Viewing Sensitivity Tables

You can export sensitivity data as tables for analysis or plotting:

```python
# As Astropy Table
table = sens.table
print(table)

# As Pandas DataFrame
df = sens.pandas
print(df.head())
```

## Sensitivity and Source Spectra

The sensitivity calculation uses the source spectral shape to optimize energy binning and background estimation. This is why you pass a `Source` object (with `get_sensitivity_curve(grb=source)`).

### Spectral Template Scaling

Internally, sensipy uses a `ScaledTemplateModel` to adjust the source normalization while preserving its spectral shape. This allows the code to find the minimum flux level that achieves the target significance.

```python
from sensipy.sensitivity import ScaledTemplateModel
from gammapy.modeling.models import TemplateSpectralModel

# Create a scaled template from a Gammapy model
template_model = TemplateSpectralModel(...)
scaled_model = ScaledTemplateModel.from_template(
    model=template_model,
    scaling_factor=1e-6  # Scale down initial normalization
)

# The scaling factor can be adjusted
scaled_model.scaling_factor = 0.5  # Reduce flux by 50%
```

<Aside type="note">
  Most users don't need to interact with `ScaledTemplateModel` directly - it's
  used internally by the sensitivity calculator.
</Aside>

## Example: Full Sensitivity Workflow

<Steps>

1. **Load IRFs**

   ```python
   from sensipy.ctaoirf import IRFHouse

   house = IRFHouse(base_directory="./CTA-IRFs")
   irf = house.get_irf(
       site="south",
       configuration="alpha",
       zenith=20,
       duration=1800,
       azimuth="average",
       version="prod5-v0.1",
   )
   ```

2. **Create Source with spectral model**

   ```python
   from sensipy.source import Source
   import astropy.units as u

   source = Source(
       filepath="grb_spectrum.csv",
       min_energy=20 * u.GeV,
       max_energy=10 * u.TeV,
       ebl="franceschini"
   )
   ```

3. **Initialize Sensitivity Calculator**

   ```python
   from sensipy.sensitivity import SensitivityGammapy

   sens = SensitivityGammapy(
       irf=irf,
       observatory="ctao_south",
       min_energy=20 * u.GeV,
       max_energy=10 * u.TeV,
       radius=3.0 * u.deg,
   )
   ```

4. **Compute Sensitivity Curve**

   ```python
   sens.get_sensitivity_curve(grb=source)
   ```

5. **Use for Detection Simulation**

   ```python
   # Now use this sensitivity to simulate observations
   result = source.observe(
       sensitivity=sens,
       start_time=30 * u.min,
       min_energy=20 * u.GeV,
       max_energy=10 * u.TeV,
   )

   print(f"Detection time: {result.get('obs_time', 'Not detected')}")
   ```

</Steps>

## Advanced Topics

### EBL Impact on Sensitivity

When using EBL absorption, the attenuated source spectrum may require longer observation times to detect:

```python
# Without EBL
source_no_ebl = Source(filepath="grb.csv", min_energy=20*u.GeV, max_energy=10*u.TeV)
sens.get_sensitivity_curve(grb=source_no_ebl)
result_no_ebl = source_no_ebl.observe(sensitivity=sens, start_time=30*u.min)

# With EBL
source_ebl = Source(filepath="grb.csv", min_energy=20*u.GeV, max_energy=10*u.TeV, ebl="franceschini")
sens.get_sensitivity_curve(grb=source_ebl)
result_ebl = source_ebl.observe(sensitivity=sens, start_time=30*u.min)

print(f"No EBL: {result_no_ebl['obs_time']}")
print(f"With EBL: {result_ebl['obs_time']}")
```

### Systematic Uncertainties

TODO: Document how to incorporate systematic uncertainties in sensitivity calculations.

## Troubleshooting

### Common Issues

**Problem**: Sensitivity calculation is very slow

**Solution**: Reduce `n_sensitivity_points` or limit the time range (`min_time`, `max_time`)

---

**Problem**: "No valid sensitivity found" error

**Solution**: Check that your source spectrum overlaps with the energy range and that the flux is not too weak to detect

---

**Problem**: Different results with different IRF versions

**Solution**: This is expected - newer IRF versions may have improved sensitivity. Always document which IRF version you use.

## Next Steps

- Learn about [Exposure Time Calculations](./exposure) to simulate observations
- See the [Tutorials](/tutorials/) for complete workflows
- Check the [Sensitivity API reference](/reference/sensitivity) for detailed documentation
