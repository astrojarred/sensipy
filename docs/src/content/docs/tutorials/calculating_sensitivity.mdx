---
title: Calculating Sensitivity
description: Computing sensitivity curves for gamma-ray observatories.
---

import {Aside, Steps, Tabs, TabItem} from "@astrojs/starlight/components";

## Objective

Learn how to calculate sensitivity curves that determine the minimum detectable flux for a gamma-ray observatory.

## Prerequisites

- IRFs loaded (see [Loading IRFs](./loading_irfs))
- A spectral model (see [Spectral Models](/getting_started/spectral_models))

## Basic Sensitivity Calculation

<Steps>

1. **Setup**

   ```python
   from sensipy.ctaoirf import IRFHouse
   from sensipy.sensitivity import SensitivityGammapy
   from sensipy.source import Source
   from astropy import units as u

   # Load IRF
   house = IRFHouse(base_directory="./CTA-IRFs")
   irf = house.get_irf(
       site="south",
       configuration="alpha",
       zenith=20,
       duration=1800,
       azimuth="average",
       version="prod5-v0.1",
   )
   ```

2. **Define Energy Range**

   ```python
   # Typical CTA energy range
   min_energy = 20 * u.GeV  # or 0.02 TeV
   max_energy = 10 * u.TeV
   ```

3. **Create Sensitivity Calculator**

   ```python
   sens = SensitivityGammapy(
       irf=irf,
       observatory=f"ctao_{irf.site.name}",
       min_energy=min_energy,
       max_energy=max_energy,
       radius=3.0 * u.deg,  # Extraction region
   )
   ```

4. **Load Source Spectrum**

   ```python
   source = Source(
       filepath="data/mock_data/GRB_42_mock.csv",
       min_energy=min_energy,
       max_energy=max_energy,
       ebl="franceschini",
   )
   ```

5. **Compute Sensitivity Curve**

   ```python
   # Calculate sensitivity for this source
   sens.get_sensitivity_curve(grb=source)

   print("Sensitivity computed!")
   print(f"Times: {sens.times}")
   print(f"Sensitivity: {sens.sensitivity_curve}")
   ```

</Steps>

## Customizing Time Range

Control the time points where sensitivity is calculated:

```python
import astropy.units as u

sens = SensitivityGammapy(
    irf=irf,
    observatory="ctao_south",
    min_energy=20 * u.GeV,
    max_energy=10 * u.TeV,
    radius=3.0 * u.deg,
    min_time=10 * u.s,        # Minimum time
    max_time=36000 * u.s,     # Maximum time (10 hours)
    n_sensitivity_points=25,  # Number of time points
)

sens.get_sensitivity_curve(grb=source)
```

## Querying Sensitivity Values

<Tabs>
  <TabItem label="Single Point">
    ```python
    import astropy.units as u

    # Get sensitivity at a specific time
    time = 1000 * u.s

    diff_sens = sens.get(time, mode="sensitivity")
    phot_flux = sens.get(time, mode="photon_flux")

    print(f"At t={time}:")
    print(f"  Differential sensitivity: {diff_sens}")
    print(f"  Photon flux sensitivity: {phot_flux}")
    ```

  </TabItem>
  
  <TabItem label="Multiple Points">
    ```python
    import numpy as np
    import astropy.units as u
    import matplotlib.pyplot as plt

    # Query at multiple times
    times = np.logspace(1, 4, 50) * u.s
    sensitivities = [sens.get(t, mode="sensitivity") for t in times]

    # Plot
    plt.figure(figsize=(10, 6))
    plt.loglog(times, sensitivities)
    plt.xlabel("Observation Time [s]")
    plt.ylabel("Differential Sensitivity [erg cm⁻² s⁻¹]")
    plt.title("CTA Sensitivity Curve")
    plt.grid(True, alpha=0.3)
    plt.show()
    ```

  </TabItem>
</Tabs>

## Viewing Sensitivity Data

<Tabs>
  <TabItem label="As Table">
    ```python
    # Get as Astropy Table
    table = sens.table
    print(table)

    # Access columns
    print(table['time'])
    print(table['sensitivity'])
    print(table['photon_flux'])
    ```

  </TabItem>
  
  <TabItem label="As DataFrame">
    ```python
    # Get as Pandas DataFrame
    df = sens.pandas
    print(df.head())

    # Easy plotting with pandas
    df.plot(x='time', y='sensitivity', loglog=True)
    ```

  </TabItem>
</Tabs>

## Comparing Different Configurations

Compare sensitivity for different observatory setups:

```python
from sensipy.ctaoirf import IRFHouse
from sensipy.sensitivity import SensitivityGammapy
from sensipy.source import Source
import astropy.units as u
import matplotlib.pyplot as plt

house = IRFHouse(base_directory="./CTA-IRFs")
source = Source(
    filepath="data/mock_data/GRB_42_mock.csv",
    min_energy=20 * u.GeV,
    max_energy=10 * u.TeV,
)

configs = [
    ("south", 20),
    ("south", 40),
    ("south", 60),
]

plt.figure(figsize=(10, 6))

for site, zenith in configs:
    # Load IRF
    irf = house.get_irf(
        site=site,
        configuration="alpha",
        zenith=zenith,
        duration=1800,
        azimuth="average",
        version="prod5-v0.1",
    )

    # Calculate sensitivity
    sens = SensitivityGammapy(
        irf=irf,
        observatory=f"ctao_{site}",
        min_energy=20 * u.GeV,
        max_energy=10 * u.TeV,
        radius=3.0 * u.deg,
    )
    sens.get_sensitivity_curve(grb=source)

    # Plot
    df = sens.pandas
    plt.loglog(df['time'], df['sensitivity'],
               label=f"{site.capitalize()} Z={zenith}°")

plt.xlabel("Observation Time [s]")
plt.ylabel("Differential Sensitivity [erg cm⁻² s⁻¹]")
plt.title("CTA Sensitivity: Different Zenith Angles")
plt.legend()
plt.grid(True, alpha=0.3)
plt.show()
```

## Impact of EBL on Sensitivity

Compare sensitivity with and without EBL absorption:

```python
import astropy.units as u
import matplotlib.pyplot as plt

# Source without EBL
source_no_ebl = Source(
    filepath="data/mock_data/GRB_42_mock.csv",
    min_energy=20 * u.GeV,
    max_energy=10 * u.TeV,
    ebl=None,  # No EBL
)

# Source with EBL
source_with_ebl = Source(
    filepath="data/mock_data/GRB_42_mock.csv",
    min_energy=20 * u.GeV,
    max_energy=10 * u.TeV,
    ebl="franceschini",
)

# Calculate both
sens = SensitivityGammapy(irf=irf, observatory="ctao_south",
                          min_energy=20*u.GeV, max_energy=10*u.TeV, radius=3.0*u.deg)

sens.get_sensitivity_curve(grb=source_no_ebl)
df_no_ebl = sens.pandas.copy()

sens.get_sensitivity_curve(grb=source_with_ebl)
df_with_ebl = sens.pandas.copy()

# Plot comparison
plt.figure(figsize=(10, 6))
plt.loglog(df_no_ebl['time'], df_no_ebl['sensitivity'], label="No EBL", linewidth=2)
plt.loglog(df_with_ebl['time'], df_with_ebl['sensitivity'], label="With EBL (Franceschini)", linewidth=2)
plt.xlabel("Observation Time [s]")
plt.ylabel("Differential Sensitivity [erg cm⁻² s⁻¹]")
plt.title("Impact of EBL on Sensitivity")
plt.legend()
plt.grid(True, alpha=0.3)
plt.show()
```

## Advanced: Using Pre-computed Curves

If you have pre-computed sensitivity values, you can create a `Sensitivity` object directly:

```python
import numpy as np
import astropy.units as u

# Pre-computed values
times = np.logspace(1, 4, 20) * u.s
sens_values = np.array([...]) * u.Unit("erg / (cm2 s)")
photon_flux_values = np.array([...]) * u.Unit("1 / (cm2 s)")

sens = SensitivityGammapy(
    irf=irf,
    observatory="ctao_south",
    min_energy=20 * u.GeV,
    max_energy=10 * u.TeV,
    radius=3.0 * u.deg,
    sensitivity_curve=sens_values,
    photon_flux_curve=photon_flux_values,
)

# Now you can use sens.get() to interpolate
```

## Troubleshooting

**Problem**: Sensitivity calculation is very slow

**Solution**: Reduce `n_sensitivity_points` or narrow the time range

---

**Problem**: "No valid sensitivity found" error

**Solution**: Check that source spectrum overlaps with energy range and has sufficient flux

## Next Steps

- Use sensitivity curves in [Simulating Observations](./simulating_observations)
- See [Exposure Calculations](/getting_started/exposure) for theory
- Check [Sensitivity API Reference](/reference/sensitivity) for detailed docs
